name: terraform-multi

on:
  workflow_call:
    inputs:
      environment: { type: string, required: true }
      tfvars_file: { type: string, required: true }
      rgname: { type: string, required: true }
      saname: { type: string, required: true }
      scname: { type: string, required: true }
      key: { type: string, required: true }

      runInit: { type: boolean, default: false }
      runPlan: { type: boolean, default: false }
      runApply: { type: boolean, default: false }
      runDestroy: { type: boolean, default: false }

      useEnvironmentInit: { type: boolean, default: false }
      useEnvironmentPlan: { type: boolean, default: false }
      useEnvironmentApply: { type: boolean, default: false }
      useEnvironmentDestroy: { type: boolean, default: false }

    secrets:
      
      AZURE_CLIENT_ID_R: { required: true }
      AZURE_CLIENT_ID_B: { required: true }

      AZURE_TENANT_ID_R: { required: true }
      AZURE_TENANT_ID_B: { required: true }

      AZURE_SUBSCRIPTION_ID_R: { required: true }
      AZURE_SUBSCRIPTION_ID_B: { required: true }
      ARM_ACCESS_KEY:           {required: true }

      

permissions:
  id-token: write
  contents: read

env:
  WORKDIR: infra

jobs:
  preview-options:
    name: Preview selected options
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Show triggerevent info
        run: |
          echo "=================================================================="
          echo " This workflow was triggered by, GITHUB EVENT: ${{ github.event_name }}"
          echo "=================================================================="
          echo ""
          echo "======================"
          echo "REF: ${{ github.ref }}"
          echo "======================"
          echo ""

      - name: Compute and print inputs + derived toggles
        env:
          input_runInit: ${{ inputs.runInit }}
          input_runPlan: ${{ inputs.runPlan }}
          input_runApply: ${{ inputs.runApply }}
          input_runDestroy: ${{ inputs.runDestroy }}

          input_useEnvironmentInit: ${{ inputs.useEnvironmentInit }}
          input_useEnvironmentPlan: ${{ inputs.useEnvironmentPlan }}
          input_useEnvironmentApply: ${{ inputs.useEnvironmentApply }}
          input_useEnvironmentDestroy: ${{ inputs.useEnvironmentDestroy }}

        run: |
          echo "---- Actual inputs received (workflow_call inputs) ----"
          echo "runInit:     $input_runInit"
          echo "runPlan:     $input_runPlan"
          echo "runApply:    $input_runApply"
          echo "runDestroy:  $input_runDestroy"
          echo ""
          echo "---- Environment approval inputs (caller-controlled) ----"
          echo "useEnvironmentInit:    $input_useEnvironmentInit"
          echo "useEnvironmentPlan:    $input_useEnvironmentPlan"
          echo "useEnvironmentApply:   $input_useEnvironmentApply"
          echo "useEnvironmentDestroy: $input_useEnvironmentDestroy"

          echo "---- Note ----"
          echo "If any job has 'environment: <non-empty>' that job will request approval from that environment's protection rules."

  # 1️⃣ INIT + FMT + VALIDATE
  init:
    if: ${{ inputs.runInit }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentInit && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_B }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID_B }}
          # use init_subscription if provided, otherwise fall back to the caller secret
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_B }}
        
      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

      - run: terraform fmt -recursive
      - run: terraform validate

  # 2️⃣ PLAN
  plan:
    name: Terraform Plan
    # needs: [init]
    # if: ${{ inputs.runPlan && (needs.init.result == 'success' || !inputs.runInit) }}
    if: ${{ inputs.runPlan }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentPlan && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4

      # 1) Login to backend tenant (Tenant B) so init can access remote state
      - name: Azure Login (backend - Tenant B)
        uses: azure/login@v2
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID_B }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_B }}
          client-id: ${{ secrets.AZURE_CLIENT_ID_B }}   # optional if needed for federated cred
          audience: api://AzureADTokenExchange

      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

        
      # 2) Switch login to resources tenant (Tenant R) for plan
      - name: Azure Login (resources - Tenant R)
        uses: azure/login@v2
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID_R }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_R }}
          client-id: ${{ secrets.AZURE_CLIENT_ID_R }}   # optional

      - name: Terraform Plan
        env:
          # ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_R }}
          ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}
          # ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID_R }}
          # ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID_R }}
        run: terraform plan -var-file="../environments/${{ inputs.environment }}.tfvars" -out="tf-plan-${{ inputs.environment }}.tfplan"

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}.tfplan
          path: infra/tf-plan-${{ inputs.environment }}.tfplan



#   plan:
#     name: Terraform Plan
#     needs: [init]
#     if: ${{ inputs.runPlan && (needs.init.result == 'success' || !inputs.runInit) }}
#     runs-on: self-hosted
#     environment: ${{ inputs.useEnvironmentPlan && inputs.environment || '' }}

#     defaults:
#       run:
#         working-directory: ${{ env.WORKDIR }}
#     steps:
#       - uses: actions/checkout@v4

#       - name: Azure Login (INIT - backend tenant)
#         uses: azure/login@v2
#         with:
#           tenant-id: ${{ secrets.AZURE_TENANT_ID_B }}
#           subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_B }}
#           client-id: ${{ secrets.AZURE_CLIENT_ID_B }} # optionally, if your federated cred requires app id
#           # audience: api://AzureADTokenExchange # optionally if your federated cred requires audience

#       # - name: Debug - show az account context
#       #   run: |
#       #     az account show
      
#       # - name: Terraform Init
#       #   run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"


# ###########
# ###########
# ###########       Yha per samjho...... 
# ###########       wha jab meine with se log in kiya , tab yeh storage account mein gya meri statefile ko dekhne ke liye
# ###########       per ab AAYA BHAI ERROR.... OR YEHI SAMAJH NA HAI.... KI JAB YEH PLAN CHALEGA... TO YEH JO STATEFILE KO ACCESS KAREGA
# ###########       WOH USI TENANT MEIN CHALEGA JISMEIN HUMNE azure/login@v2  KARWAYA HAI....
# ###########       AB YHA DO CASE:- 1. AGAR BACKEND OR RESOURCES SAME TENANT MEIN HAIN, TOH KOI PROBLEM NAHI
# ###########                       2. AGAR BACKEND OR RESOURCES ALAG-ALAG TENANT MEIN HAIN, TOH PROBLEM HOGI
# ###########       KYUKI JAB HUM PLAN KARNE JAAYENGE, TOH WOHI CONTEXT USE KAREGA JO HUMNE LOGIN KARWAYA HAI NICHE WLE STEP MEIN
# ###########       OR WOHI CONTEXT USE KAREGA JO HUMNE LOGIN KARWAYA HAI NICHE WLE STEP MEIN , PER HUMARA BACKEND DUSRE TENANT MEIN HAI
# ###########       TABHI HUM BACKEND WALE SE azure/login@v2 , KARWAKAR .... INIT CHALWAKR , FIR PLAN STEP MEIN US-SE ENVIRONMENT LOGIN KARWATE HAI..
#       # - name: Azure Login (PLAN - resources tenant)
#       #   uses: azure/login@v2
#       #   with:
#       #     tenant-id: ${{ secrets.AZURE_TENANT_ID_R }}
#       #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_R }}
#       #     client-id: ${{ secrets.AZURE_CLIENT_ID_R }} # optionally, if your federated cred requires app id

#       # - name: Debug - show az account
#       #   run: az account show

#       # - name: Terraform Plan
#       #   run: terraform plan -var-file="../environments/${{ inputs.environment }}.tfvars" -out="tf-plan-${{ inputs.environment }}.tfplan"
# ###########
# ###########        TO AB HUM YHA KYA KARANGE ???
# ###########        aB HUM YHA PER ENV SE VALUES KO PASS KARWAYANGE.....

#       - name: Terraform Plan
#         env:
#           ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_R }}
#           ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID_R }}
#           ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID_R }}
#         run: terraform plan -var-file="../environments/${{ inputs.environment }}.tfvars" -out="tf-plan-${{ inputs.environment }}.tfplan"

#       - name: Upload plan
#         uses: actions/upload-artifact@v4
#         with:
#           name: tf-plan-${{ inputs.environment }}.tfplan
#           path: infra/tf-plan-${{ inputs.environment }}.tfplan

  # # 3️⃣ APPLY
  # apply:
  #   needs: [plan]
  #   if: ${{ inputs.runApply && needs.plan.result == 'success' }}
  #   runs-on: self-hosted
  #   environment: ${{ inputs.useEnvironmentApply && inputs.environment || '' }}
  #   defaults:
  #     run:
  #       working-directory: ${{ env.WORKDIR }}
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: azure/login@v2
  #       with:
  #         client-id: ${{ secrets.CLIENT_ID_SUBSCRIPTION_BACKEND }}
  #         tenant-id: ${{ secrets.TENANT_ID_SUBSCRIPTION_BACKEND }}
  #         # apply should use the same subscription as plan (use plan_subscription if given)
  #         subscription-id: ${{ secrets.SUBSCRIPTION_ID_BACKEND }}

  #     - name: Download plan
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: tf-plan-${{ inputs.environment }}.tfplan
  #         path: infra

  #     - name: Terraform Init
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

  #     - name: Terraform Apply
  #       env:
  #         ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  #         ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  #         ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #       run: terraform apply -auto-approve "tf-plan-${{ inputs.environment }}.tfplan"

  # # 4️⃣ DESTROY
  # destroy:
  #   if: ${{ inputs.runDestroy }}
  #   runs-on: self-hosted
  #   environment: ${{ inputs.useEnvironmentDestroy && inputs.environment || '' }}
  #   defaults:
  #     run:
  #       working-directory: ${{ env.WORKDIR }}

  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: azure/login@v2
  #       with:
  #         client-id: ${{ secrets.CLIENT_ID_SUBSCRIPTION_BACKEND }}
  #         tenant-id: ${{ secrets.TENANT_ID_SUBSCRIPTION_BACKEND }}
  #         subscription-id: ${{ secrets.SUBSCRIPTION_ID_BACKEND }}

  #     - name: Terraform Init
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

  #     - name: Terraform Destroy
  #       env:
  #         ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  #         ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  #         ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #       run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"
